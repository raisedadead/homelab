---
- name: Setup Portainer
  hosts: "{{ variable_host | default('none') }}"
  become: true

  vars:
    portainer_version: "lts"
    portainer_dir: "/opt/portainer"

  tasks:
    - name: Create Portainer directory
      ansible.builtin.file:
        path: "{{ portainer_dir }}"
        state: directory
        mode: "0755"

    - name: Copy docker-compose file
      ansible.builtin.template:
        src: templates/portainer/docker-compose.yml.j2
        dest: "{{ portainer_dir }}/docker-compose.yml"
        mode: "0644"

    - name: Pull and start Portainer
      ansible.builtin.command:
        cmd: docker compose up -d --pull always
        chdir: "{{ portainer_dir }}"
      register: portainer_start
      changed_when: "'Started' in portainer_start.stderr or 'Creating' in portainer_start.stderr or 'Recreating' in portainer_start.stderr"

    - name: Show Portainer access info
      ansible.builtin.debug:
        msg:
          - "Portainer is running!"
          - "Access at: https://{{ inventory_hostname }}:9443"
          - "Uses self-signed certificate."
