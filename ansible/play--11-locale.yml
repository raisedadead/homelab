---
- name: Setup Locale
  hosts: "{{ variable_host | default('none') }}"
  become: true
  become_user: root

  vars:
    locale_lang: "en_US.UTF-8"
    locale_all: "en_US.UTF-8"
    locale_generate:
      - "en_US.UTF-8 UTF-8"
      - "en_IN.UTF-8 UTF-8"

  tasks:
    - name: Ensure locales package is installed
      ansible.builtin.apt:
        name: locales
        state: present
        update_cache: true

    - name: Generate required locales
      ansible.builtin.lineinfile:
        path: /etc/locale.gen
        regexp: "^#?{{ item | regex_escape }}$"
        line: "{{ item }}"
        state: present
      loop: "{{ locale_generate }}"
      register: locale_gen_config

    - name: Run locale-gen
      ansible.builtin.command:
        cmd: locale-gen
      when: locale_gen_config.changed

    - name: Set default locale
      ansible.builtin.copy:
        content: |
          LANG={{ locale_lang }}
          LC_ALL={{ locale_all }}
        dest: /etc/default/locale
        mode: "0644"

    - name: Set locale in /etc/environment
      ansible.builtin.lineinfile:
        path: /etc/environment
        regexp: "^{{ item.key }}="
        line: "{{ item.key }}={{ item.value }}"
        create: true
        mode: "0644"
      loop:
        - { key: "LANG", value: "{{ locale_lang }}" }
        - { key: "LC_ALL", value: "{{ locale_all }}" }

    - name: Create locale profile script (overrides SSH forwarded locale)
      ansible.builtin.copy:
        content: |
          export LANG={{ locale_lang }}
          export LC_ALL={{ locale_all }}
        dest: /etc/profile.d/locale.sh
        mode: "0644"

    - name: Update current session locale
      ansible.builtin.shell:
        cmd: update-locale LANG={{ locale_lang }} LC_ALL={{ locale_all }}

    - name: Verify locale
      ansible.builtin.command:
        cmd: locale
      register: locale_check
      changed_when: false

    - name: Display locale status
      ansible.builtin.debug:
        msg:
          - "Locale configured successfully"
          - "LANG={{ locale_lang }}"
          - "LC_ALL={{ locale_all }}"
          - "Note: Log out and back in for full effect"
